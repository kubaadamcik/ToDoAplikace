@page "/todo"
@using System.Text.Json
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Mvc
@using Mono.TextTemplating
@using ToDoAplikace.Data
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject UserManager<User> UserManager
@inject SignInManager<User> SignInManager
@inject IJSRuntime JSRuntime

@attribute [Authorize]

<h3>Todo</h3>

<div class="container">
    <div class="row">

    </div>
</div>

@code {

    private List<ToDoTask>? tasks { get; set; }

    private string userId { get; set; }

    private bool _isLoading;

    private bool isLoading { get => _isLoading; set { _isLoading = value; StateHasChanged(); } }


    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        var user = await UserManager.GetUserAsync(SignInManager.Context.User);

        if (user is not null && firstRender)
        {
            userId = user.Id;
            await FetchTasks();
        }
    }

    private async Task FetchTasks()
    {
        var request = await JSRuntime.InvokeAsync<List<ToDoTask>>("tasks.getTasks", userId);

        tasks = request;

        StateHasChanged();
    }


    private async Task CreateTask()
    {
        ToDoTask task = new ToDoTask() { Name = "Task", CreatedAt = DateTime.Now, Deadline = DateTime.Now, Description = "AHOj", UserId = userId };

        var taskJson = System.Text.Json.JsonSerializer.Serialize(task);

        isLoading = true;
        var request = await JSRuntime.InvokeAsync<bool>("tasks.createTask", task);

        isLoading = false;
    }
}
